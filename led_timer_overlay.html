<!doctype html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>LED Timer Overlay</title>
<style>
  body{margin:0;background:transparent;overflow:hidden}
  .stage{position:fixed;inset:0;display:flex;align-items:flex-end;justify-content:flex-end;padding:80px;pointer-events:none}
  .board{background:#111;padding:20px 28px;border-radius:12px;box-shadow:inset 0 0 25px rgba(0,0,0,.9),0 20px 60px rgba(0,0,0,.6)}
  .display{display:flex;gap:14px;align-items:center}

  .digit{position:relative;width:70px;height:120px}
  .segment{position:absolute;background:#300;border-radius:6px;transition:background .08s linear, box-shadow .08s linear}
  .on{background:#ff1a1a;box-shadow:0 0 12px #ff1a1a,0 0 25px #ff0000}

  .segA{top:0;left:12px;width:46px;height:10px}
  .segB{top:10px;right:0;width:10px;height:46px}
  .segC{bottom:10px;right:0;width:10px;height:46px}
  .segD{bottom:0;left:12px;width:46px;height:10px}
  .segE{bottom:10px;left:0;width:10px;height:46px}
  .segF{top:10px;left:0;width:10px;height:46px}
  .segG{top:55px;left:12px;width:46px;height:10px}

  .colon{width:20px;height:120px;position:relative}
  .dot{position:absolute;left:4px;width:10px;height:10px;border-radius:50%;background:#300}
  .dot.on{background:#ff1a1a;box-shadow:0 0 12px #ff0000}
  .dot.top{top:35px}
  .dot.bottom{bottom:35px}
</style>
</head>
<body>
<div class="stage">
  <div class="board">
    <div class="display" id="display"></div>
  </div>
</div>

<script>
  const DB = "https://swim-timer-fafd3-default-rtdb.firebaseio.com";
  const TOTAL = 24*60*60;

  const params = new URLSearchParams(location.search);
  const room = String(params.get("room") || "swim-timer").replace(/[.#$\[\]\/]/g, "-");
  const timerUrl = () => `${DB}/rooms/${encodeURIComponent(room)}/timer.json`;

  const digitMap = {
    "0":["A","B","C","D","E","F"],"1":["B","C"],"2":["A","B","G","E","D"],"3":["A","B","G","C","D"],
    "4":["F","G","B","C"],"5":["A","F","G","C","D"],"6":["A","F","E","D","C","G"],"7":["A","B","C"],
    "8":["A","B","C","D","E","F","G"],"9":["A","B","C","D","F","G"]
  };

  function clamp(n,a,b){ return Math.max(a, Math.min(b,n)); }
  function fmtHMS(secs){
    secs = clamp(Math.floor(secs),0,TOTAL);
    const h=Math.floor(secs/3600), m=Math.floor((secs%3600)/60), s=secs%60;
    return String(h).padStart(2,"0")+String(m).padStart(2,"0")+String(s).padStart(2,"0");
  }

  function createDigit(){
    const d=document.createElement("div"); d.className="digit";
    ["A","B","C","D","E","F","G"].forEach(s=>{
      const seg=document.createElement("div");
      seg.className="segment seg"+s;
      seg.dataset.seg=s;
      d.appendChild(seg);
    });
    return d;
  }
  function createColon(){
    const c=document.createElement("div"); c.className="colon";
    const t=document.createElement("div"); t.className="dot top";
    const b=document.createElement("div"); b.className="dot bottom";
    c.appendChild(t); c.appendChild(b);
    return c;
  }
  function setDigit(el, ch){
    el.querySelectorAll(".segment").forEach(s=>s.classList.remove("on"));
    (digitMap[ch]||[]).forEach(seg=>{
      const node=el.querySelector(`[data-seg="${seg}"]`);
      if(node) node.classList.add("on");
    });
  }

  const display=document.getElementById("display");
  const parts=[];
  for(let i=0;i<8;i++){
    if(i===2||i===5){
      const col=createColon();
      col.querySelectorAll(".dot").forEach(d=>d.classList.add("on"));
      display.appendChild(col);
      parts.push(col);
    }else{
      const d=createDigit();
      display.appendChild(d);
      parts.push(d);
    }
  }

  function renderSeconds(secs){
    const str=fmtHMS(secs);
    let idx=0;
    for(const el of parts){
      if(el.classList.contains("digit")){
        setDigit(el, str[idx]); idx++;
      }
    }
  }

  let state=null;

  function computeCurrent(st){
    if(!st) return TOTAL;
    const mode=(st.mode==="up")?"up":"down";
    const running=!!st.running;
    let base=Number.isFinite(st.baseSeconds)?st.baseSeconds:(mode==="up"?0:TOTAL);
    base=clamp(base,0,TOTAL);
    if(!running) return base;
    const startAt=Number(st.startAt||0);
    if(!startAt) return base;
    const elapsed=Math.max(0,Math.floor((Date.now()-startAt)/1000));
    return (mode==="up")?clamp(base+elapsed,0,TOTAL):clamp(base-elapsed,0,TOTAL);
  }

  async function fetchState(){
    try{
      const res=await fetch(timerUrl(), {cache:"no-store"});
      if(!res.ok) throw new Error("HTTP "+res.status);
      state=await res.json();
    }catch(e){}
  }

  async function tick(){
    await fetchState();
    renderSeconds(computeCurrent(state));
  }

  // initial
  tick();
  // smooth display
  setInterval(()=>renderSeconds(computeCurrent(state)), 200);
  // keep synced
  setInterval(tick, 1200);
</script>
</body>
</html>
