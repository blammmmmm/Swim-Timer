<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>LED Timer Overlay</title>
<style>
  html,body{margin:0;background:transparent;overflow:hidden}

  /* Position */
  .stage{
    position:fixed; inset:0;
    display:flex;
    justify-content:flex-end;
    align-items:flex-end;
    padding:80px;
    pointer-events:none;
  }

  /* LED board */
  .board{
    background:#111;
    padding:20px 28px;
    border-radius:12px;
    box-shadow:
      inset 0 0 25px rgba(0,0,0,.9),
      0 20px 60px rgba(0,0,0,.6);
  }

  .display{display:flex;gap:14px;align-items:center}

  .digit{
    position:relative;
    width:70px;
    height:120px;
  }

  .segment{
    position:absolute;
    background:#300;
    border-radius:6px;
    transition:background .08s linear, box-shadow .08s linear;
  }
  .on{
    background:#ff1a1a;
    box-shadow:0 0 12px #ff1a1a, 0 0 25px #ff0000;
  }

  /* segment positions */
  .segA{top:0; left:12px; width:46px; height:10px;}
  .segB{top:10px; right:0; width:10px; height:46px;}
  .segC{bottom:10px; right:0; width:10px; height:46px;}
  .segD{bottom:0; left:12px; width:46px; height:10px;}
  .segE{bottom:10px; left:0; width:10px; height:46px;}
  .segF{top:10px; left:0; width:10px; height:46px;}
  .segG{top:55px; left:12px; width:46px; height:10px;}

  .colon{
    width:20px;
    height:120px;
    position:relative;
  }
  .dot{
    position:absolute;
    left:4px;
    width:10px;
    height:10px;
    border-radius:50%;
    background:#300;
  }
  .dot.on{
    background:#ff1a1a;
    box-shadow:0 0 12px #ff0000;
  }
  .dot.top{top:35px}
  .dot.bottom{bottom:35px}

  /* Tiny optional label (off by default) */
  .meta{
    margin-top:10px;
    font:600 12px/1 system-ui,-apple-system,Segoe UI,Roboto;
    color:rgba(255,255,255,0.55);
    display:none;
  }
</style>
</head>

<body>
  <div class="stage">
    <div class="board">
      <div class="display" id="display"></div>
      <div class="meta" id="meta"></div>
    </div>
  </div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
  // ===== Firebase config (Swim Timer project) =====
  const firebaseConfig = {
    apiKey: "AIzaSyD3YIe1lBy625FN_ujSnwGJXSvDUGbDYfU",
    authDomain: "brad-swim-overlay.firebaseapp.com",
    databaseURL: "https://swim-timer-fafd3-default-rtdb.firebaseio.com",
    projectId: "swim-timer-fafd3",
    storageBucket: "swim-timer-fafd3.appspot.com",
    messagingSenderId: "438110148127",
    appId: "1:438110148127:web:2bcbb03875e68304c0a72a"
  };
  // NOTE: If your Swim-Timer project has different keys than this,
  // paste the exact config from that project's Web App settings.
  // ===============================================

  const TOTAL_SECONDS = 24 * 60 * 60;

  function sanitizeRoom(s){
    // RTDB keys cannot contain . # $ [ ] /
    return String(s || "swim-timer").replace(/[.#$\[\]\/]/g, "-");
  }

  function clamp(n,a,b){ return Math.max(a, Math.min(b,n)); }

  function fmtHMS(secs){
    secs = Math.floor(secs);
    secs = clamp(secs, 0, TOTAL_SECONDS);
    const h = Math.floor(secs/3600);
    const m = Math.floor((secs%3600)/60);
    const s = secs%60;
    return String(h).padStart(2,"0")+String(m).padStart(2,"0")+String(s).padStart(2,"0");
  }

  // 7-seg mapping
  const digitMap = {
    "0":["A","B","C","D","E","F"],
    "1":["B","C"],
    "2":["A","B","G","E","D"],
    "3":["A","B","G","C","D"],
    "4":["F","G","B","C"],
    "5":["A","F","G","C","D"],
    "6":["A","F","E","D","C","G"],
    "7":["A","B","C"],
    "8":["A","B","C","D","E","F","G"],
    "9":["A","B","C","D","F","G"]
  };

  function createDigit(){
    const d = document.createElement("div");
    d.className = "digit";
    ["A","B","C","D","E","F","G"].forEach(s=>{
      const seg = document.createElement("div");
      seg.className = "segment seg"+s;
      seg.dataset.seg = s;
      d.appendChild(seg);
    });
    return d;
  }

  function createColon(){
    const c = document.createElement("div");
    c.className = "colon";
    const t = document.createElement("div");
    t.className = "dot top";
    const b = document.createElement("div");
    b.className = "dot bottom";
    c.appendChild(t); c.appendChild(b);
    return c;
  }

  function setDigit(el, numChar){
    el.querySelectorAll(".segment").forEach(s=>s.classList.remove("on"));
    const onList = digitMap[numChar] || [];
    onList.forEach(seg=>{
      const node = el.querySelector(`[data-seg="${seg}"]`);
      if(node) node.classList.add("on");
    });
  }

  // Build HH:MM:SS display (6 digits + 2 colons)
  const display = document.getElementById("display");
  const parts = [];
  for(let i=0;i<8;i++){
    if(i===2 || i===5){
      const col = createColon();
      display.appendChild(col);
      parts.push(col);
    }else{
      const d = createDigit();
      display.appendChild(d);
      parts.push(d);
    }
  }

  function renderSeconds(secs){
    const str = fmtHMS(secs); // "HHMMSS"
    let idx = 0;
    for(const el of parts){
      if(el.classList.contains("digit")){
        setDigit(el, str[idx]);
        idx++;
      }else{
        el.querySelectorAll(".dot").forEach(d=>d.classList.add("on"));
      }
    }
  }

  // ===== Firebase state -> current seconds =====
  // State written by controller at rooms/<room>/timer:
  // { mode, running, baseSeconds, startAt }
  let lastState = null;

  function nowMs(){ return Date.now(); }

  function computeCurrentSeconds(state){
    if(!state){
      return TOTAL_SECONDS; // default visual
    }
    const mode = (state.mode === "up") ? "up" : "down";
    const running = !!state.running;
    let base = Number.isFinite(state.baseSeconds) ? state.baseSeconds : (mode==="up" ? 0 : TOTAL_SECONDS);
    base = clamp(base, 0, TOTAL_SECONDS);

    if(!running) return base;

    const startAt = Number(state.startAt || 0);
    if(!startAt) return base;

    const elapsed = Math.max(0, Math.floor((nowMs() - startAt) / 1000));

    if(mode === "up") return clamp(base + elapsed, 0, TOTAL_SECONDS);
    return clamp(base - elapsed, 0, TOTAL_SECONDS);
  }

  // URL room
  const params = new URLSearchParams(location.search);
  const room = sanitizeRoom(params.get("room") || "swim-timer");

  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  const timerRef = db.ref("rooms/" + room + "/timer");

  timerRef.on("value", (snap)=>{
    lastState = snap.val() || null;
    renderSeconds(computeCurrentSeconds(lastState));
  });

  // tick locally so it animates between Firebase writes
  setInterval(()=>{
    if(!lastState) return;
    renderSeconds(computeCurrentSeconds(lastState));
  }, 200);

  // initial
  renderSeconds(TOTAL_SECONDS);
</script>
</body>
</html>
