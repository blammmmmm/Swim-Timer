<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Swim Timer Controller</title>
<style>
  :root{--bg:#0b0f18;--card:#101829;--text:#e9eefc;--muted:rgba(233,238,252,.7);--btn:#16233a;--btn2:#1a2b48;--red:#ff1a1a;--aqua:#48e3ff;}
  html,body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto}
  .wrap{max-width:900px;margin:0 auto;padding:18px}
  .top{display:flex;gap:12px;flex-wrap:wrap;align-items:center;justify-content:space-between;padding:14px;border-radius:14px;
    background:linear-gradient(135deg,rgba(72,227,255,.08),rgba(255,255,255,.03));border:1px solid rgba(255,255,255,.06)}
  .pill{display:flex;gap:10px;align-items:center;flex-wrap:wrap;padding:10px 12px;border-radius:999px;background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.06)}
  .label{font-size:12px;color:var(--muted);letter-spacing:.02em}
  .value{font-weight:900}
  .status{display:flex;gap:8px;align-items:center;font-size:12px;color:var(--muted)}
  .dot{width:8px;height:8px;border-radius:50%;background:#777}
  .dot.ok{background:#3cff8b}
  .dot.bad{background:#ff4b4b}

  .grid{display:grid;grid-template-columns:1fr;gap:12px;margin-top:12px}
  @media (min-width:820px){ .grid{grid-template-columns: 1.15fr .85fr;} }
  .panel{background:var(--card);border:1px solid rgba(255,255,255,.06);border-radius:16px;padding:14px}
  .panel h3{margin:0 0 10px 0;font-size:14px;color:var(--muted);font-weight:900;letter-spacing:.02em}
  .big{font-size:46px;font-weight:1000;letter-spacing:-.02em;color:var(--red);text-shadow:0 0 12px rgba(255,26,26,.35);margin:6px 0 10px}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .btn{appearance:none;border:1px solid rgba(255,255,255,.08);background:var(--btn);color:var(--text);padding:10px 12px;border-radius:12px;font-weight:1000;cursor:pointer;user-select:none}
  .btn:hover{background:var(--btn2)}
  .btn.primary{background:rgba(72,227,255,.12);border-color:rgba(72,227,255,.28)}
  .btn.danger{background:rgba(255,26,26,.12);border-color:rgba(255,26,26,.28)}
  .btn.ghost{background:transparent}
  .inputs{display:flex;gap:10px;flex-wrap:wrap}
  input,select{background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.09);color:var(--text);padding:10px 12px;border-radius:12px;font-weight:900;outline:none}
  .hint{font-size:12px;color:var(--muted);margin-top:8px;line-height:1.4}
  code{background:rgba(255,255,255,.05);padding:2px 6px;border-radius:8px}
</style>
</head>
<body>
<div class="wrap">
  <div class="top">
    <div class="pill">
      <div>
        <div class="label">Room</div>
        <div class="value" id="roomLabel">—</div>
      </div>
      <div style="width:1px;height:26px;background:rgba(255,255,255,.08)"></div>
      <div>
        <div class="label">Mode</div>
        <div class="value" id="modeLabel">—</div>
      </div>
      <div style="width:1px;height:26px;background:rgba(255,255,255,.08)"></div>
      <div>
        <div class="label">Running</div>
        <div class="value" id="runningLabel">—</div>
      </div>
    </div>
    <div class="status">
      <div class="dot" id="connDot"></div>
      <div id="connText">Connecting…</div>
    </div>
  </div>

  <div class="grid">
    <div class="panel">
      <h3>Timer</h3>
      <div class="big" id="display">00:00:00</div>

      <div class="row">
        <button class="btn primary" id="btnStart">Start</button>
        <button class="btn" id="btnPause">Pause</button>
        <button class="btn danger" id="btnReset">Reset (24h)</button>
        <button class="btn ghost" id="btnZero">Set 00:00:00</button>
      </div>

      <div style="height:12px"></div>

      <div class="row">
        <button class="btn" data-add="-300">-5m</button>
        <button class="btn" data-add="-60">-1m</button>
        <button class="btn" data-add="-10">-10s</button>
        <button class="btn" data-add="10">+10s</button>
        <button class="btn" data-add="60">+1m</button>
        <button class="btn" data-add="300">+5m</button>
      </div>

      <div class="hint">
        REST path: <code>rooms/&lt;room&gt;/timer</code>. URL param: <code>?room=swim-timer</code>
      </div>
    </div>

    <div class="panel">
      <h3>Settings</h3>
      <div class="inputs">
        <select id="modeSelect">
          <option value="down">Count Down (24:00:00 → 00:00:00)</option>
          <option value="up">Count Up (00:00:00 → 24:00:00)</option>
        </select>
      </div>

      <div style="height:10px"></div>

      <div class="inputs">
        <input id="setHH" type="number" min="0" max="24" placeholder="HH" style="width:90px">
        <input id="setMM" type="number" min="0" max="59" placeholder="MM" style="width:90px">
        <input id="setSS" type="number" min="0" max="59" placeholder="SS" style="width:90px">
        <button class="btn" id="btnSetTime">Set Time</button>
      </div>

      <div class="hint">Set Time pauses and sets the display instantly.</div>
    </div>
  </div>
</div>

<script>
  // ✅ ONLY THING THAT MUST BE RIGHT:
  const DB = "https://swim-timer-fafd3-default-rtdb.firebaseio.com";

  const TOTAL = 24*60*60;

  const params = new URLSearchParams(location.search);
  const room = String(params.get("room") || "swim-timer").replace(/[.#$\[\]\/]/g, "-");

  const roomLabel = document.getElementById("roomLabel");
  const modeLabel = document.getElementById("modeLabel");
  const runningLabel = document.getElementById("runningLabel");
  const modeSelect = document.getElementById("modeSelect");
  const displayEl = document.getElementById("display");
  const connDot = document.getElementById("connDot");
  const connText = document.getElementById("connText");

  roomLabel.textContent = room;

  const timerUrl = () => `${DB}/rooms/${encodeURIComponent(room)}/timer.json`;

  function clamp(n,a,b){ return Math.max(a, Math.min(b,n)); }
  function fmt(secs){
    secs = clamp(Math.floor(secs), 0, TOTAL);
    const h = Math.floor(secs/3600);
    const m = Math.floor((secs%3600)/60);
    const s = secs%60;
    return String(h).padStart(2,"0")+":"+String(m).padStart(2,"0")+":"+String(s).padStart(2,"0");
  }

  let state = null;

  function computeCurrent(st){
    if(!st) return TOTAL;
    const mode = (st.mode==="up") ? "up" : "down";
    const running = !!st.running;
    let base = Number.isFinite(st.baseSeconds) ? st.baseSeconds : (mode==="up" ? 0 : TOTAL);
    base = clamp(base, 0, TOTAL);
    if(!running) return base;
    const startAt = Number(st.startAt || 0);
    if(!startAt) return base;
    const elapsed = Math.max(0, Math.floor((Date.now() - startAt)/1000));
    return (mode==="up") ? clamp(base + elapsed, 0, TOTAL) : clamp(base - elapsed, 0, TOTAL);
  }

  function render(){
    const mode = (state?.mode==="up") ? "up" : "down";
    const running = !!state?.running;
    modeLabel.textContent = mode.toUpperCase();
    runningLabel.textContent = running ? "YES" : "NO";
    modeSelect.value = mode;
    displayEl.textContent = fmt(computeCurrent(state));
  }

  async function fetchState(){
    try{
      const res = await fetch(timerUrl(), {cache:"no-store"});
      if(!res.ok) throw new Error("HTTP "+res.status);
      const json = await res.json();
      state = json;
      connDot.className = "dot ok";
      connText.textContent = "Connected";
      render();
    }catch(e){
      connDot.className = "dot bad";
      connText.textContent = "Disconnected";
    }
  }

  async function patch(patchObj){
    await fetch(timerUrl(), {
      method:"PATCH",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify(patchObj)
    });
    await fetchState();
  }

  async function ensureInit(){
    await fetchState();
    if(!state){
      state = { mode:"down", running:false, baseSeconds:TOTAL, startAt:0, updatedAt:Date.now() };
      await fetch(timerUrl(), {
        method:"PUT",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify(state)
      });
      await fetchState();
    }
  }

  async function start(){
    await ensureInit();
    if(state?.running) return;
    const mode = (state?.mode==="up") ? "up" : "down";
    const base = computeCurrent({ ...state, running:false, startAt:0 });
    await patch({ mode, running:true, baseSeconds:base, startAt:Date.now(), updatedAt:Date.now() });
  }

  async function pause(){
    await ensureInit();
    if(!state?.running) return;
    const current = computeCurrent(state);
    await patch({ running:false, baseSeconds:current, startAt:0, updatedAt:Date.now() });
  }

  async function reset24h(){
    await ensureInit();
    const mode = (state?.mode==="up") ? "up" : "down";
    const base = (mode==="up") ? 0 : TOTAL;
    await patch({ mode, running:false, baseSeconds:base, startAt:0, updatedAt:Date.now() });
  }

  async function setZero(){
    await ensureInit();
    const mode = (state?.mode==="up") ? "up" : "down";
    await patch({ mode, running:false, baseSeconds:0, startAt:0, updatedAt:Date.now() });
  }

  async function addSeconds(delta){
    await ensureInit();
    const current = computeCurrent(state);
    const next = clamp(current + delta, 0, TOTAL);
    await patch({ running:false, baseSeconds:next, startAt:0, updatedAt:Date.now() });
  }

  async function setMode(newMode){
    await ensureInit();
    newMode = (newMode==="up") ? "up" : "down";
    const oldMode = (state?.mode==="up") ? "up" : "down";
    const displayed = computeCurrent(state);

    // keep the displayed time consistent through switch
    let baseSeconds;
    if(newMode === oldMode){
      baseSeconds = displayed;
    } else {
      baseSeconds = TOTAL - displayed;
    }
    baseSeconds = clamp(baseSeconds, 0, TOTAL);
    await patch({ mode:newMode, running:false, baseSeconds, startAt:0, updatedAt:Date.now() });
  }

  async function setExact(){
    await ensureInit();
    const hh = clamp(parseInt(document.getElementById("setHH").value||"0",10),0,24);
    const mm = clamp(parseInt(document.getElementById("setMM").value||"0",10),0,59);
    const ss = clamp(parseInt(document.getElementById("setSS").value||"0",10),0,59);
    const total = clamp(hh*3600 + mm*60 + ss, 0, TOTAL);
    await patch({ running:false, baseSeconds:total, startAt:0, updatedAt:Date.now() });
  }

  document.getElementById("btnStart").addEventListener("click", start);
  document.getElementById("btnPause").addEventListener("click", pause);
  document.getElementById("btnReset").addEventListener("click", reset24h);
  document.getElementById("btnZero").addEventListener("click", setZero);
  document.querySelectorAll("[data-add]").forEach(b=>b.addEventListener("click",()=>addSeconds(parseInt(b.dataset.add,10))));
  modeSelect.addEventListener("change", e=>setMode(e.target.value));
  document.getElementById("btnSetTime").addEventListener("click", setExact);

  // initial + keep display alive
  fetchState();
  setInterval(()=>{ if(state?.running){ render(); } }, 250);
  setInterval(fetchState, 1500); // keep in sync across devices
</script>
</body>
</html>
